name: Checkov Scan

on:
  pull_request:
    paths:
      - '**.tf'

jobs:
  checkov:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install Checkov
      run: pip install checkov

    - name: Run Checkov on changed Terraform files
      id: checkov
      run: |
        FILES=$(git diff --name-only --diff-filter=d ${{ github.event.before }} ${{ github.event.after }} -- '*.tf' | tr '\n' ' ')
        if [ -n "$FILES" ]; then
          for file in $FILES; do
            checkov -f $file --output json --quiet --framework terraform >> checkov_results.json
          done
        else
          echo "No Terraform files changed."
        fi

    - name: Comment on PR
      if: steps.checkov.outputs.checkov_result != ''
      uses: actions/github-script@v5
      with:
        script: |
          const fs = require('fs');
          const results = JSON.parse(fs.readFileSync('checkov_results.json', 'utf8'));
          let comment = "### Checkov Results 🛡️\n\n";
          if (results.results.failed_checks.length > 0) {
            comment += "| File | Checkov Error | Description |\n";
            comment += "|------|--------------|-------------|\n";
            for (const check of results.results.failed_checks) {
              comment += `| ${check.file_path} | ${check.check_id} | ${check.check_name} |\n`;
            }
          } else {
            comment += "🎉 Congratulations! No Checkov errors were found.\n";
          }
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
